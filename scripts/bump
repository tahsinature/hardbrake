#!/bin/bash
# ────────────────────────────────────────────────────────────
# Bump version in package.json, tauri.conf.json, and Cargo.toml.
#
# CI mode  (CI=true) : reads conventional commits since the last
#                       tag to decide major / minor / patch.
# Interactive mode    : prompts for the bump type.
#
# After bumping, creates a git commit + tag locally.
# The caller (version.yml / human) is responsible for pushing.
# ────────────────────────────────────────────────────────────
set -euo pipefail

ROOT="$(cd "$(dirname "$0")/.." && pwd)"
CURRENT=$(jq -r .version "$ROOT/package.json")

# ── Determine bump type ───────────────────────────────────────
if [ -n "${CI:-}" ]; then
  LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

  if [ -n "$LAST_TAG" ]; then
    COMMITS=$(git log "$LAST_TAG"..HEAD --format="%s" --no-merges)
  else
    COMMITS=$(git log --format="%s" --no-merges)
  fi

  if [ -z "$COMMITS" ]; then
    echo "No new commits. Skipping."
    exit 0
  fi

  BUMP=""
  if echo "$COMMITS" | grep -qiE "BREAKING.CHANGE|^[a-z]+(\(.+\))?!:"; then
    BUMP="major"
  elif echo "$COMMITS" | grep -qE "^feat(\(.+\))?:"; then
    BUMP="minor"
  elif echo "$COMMITS" | grep -qE "^fix(\(.+\))?:"; then
    BUMP="patch"
  fi

  if [ -z "$BUMP" ]; then
    echo "No version-relevant conventional commits. Skipping."
    exit 0
  fi

  # Build release notes from commit subjects
  NOTES=""
  BREAKING=$(echo "$COMMITS" | grep -iE "BREAKING.CHANGE|^[a-z]+(\(.+\))?!:" || true)
  FEATS=$(echo "$COMMITS"   | grep -E  "^feat(\(.+\))?:"                     || true)
  FIXES=$(echo "$COMMITS"   | grep -E  "^fix(\(.+\))?:"                      || true)

  [ -n "$BREAKING" ] && NOTES+=$'\n## ⚠️ Breaking Changes\n'"$(echo "$BREAKING" | sed 's/^/- /')"$'\n'
  [ -n "$FEATS" ]    && NOTES+=$'\n## Features\n'"$(echo "$FEATS" | sed 's/^/- /')"$'\n'
  [ -n "$FIXES" ]    && NOTES+=$'\n## Bug Fixes\n'"$(echo "$FIXES" | sed 's/^/- /')"$'\n'
else
  read -rp "Version bump type (major/minor/patch): " BUMP
  if [[ ! "$BUMP" =~ ^(major|minor|patch)$ ]]; then
    echo "Invalid version bump type. Exiting."
    exit 1
  fi
fi

# ── Calculate new version ─────────────────────────────────────
IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
case "$BUMP" in
  major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
  minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
  patch) PATCH=$((PATCH + 1)) ;;
esac
NEW="$MAJOR.$MINOR.$PATCH"

echo "Bumping $CURRENT → $NEW ($BUMP)"

# ── Update version in all files ───────────────────────────────
tmp=$(mktemp)
jq --arg v "$NEW" '.version = $v' "$ROOT/package.json" > "$tmp" && mv "$tmp" "$ROOT/package.json"

tmp=$(mktemp)
jq --arg v "$NEW" '.version = $v' "$ROOT/src-tauri/tauri.conf.json" > "$tmp" && mv "$tmp" "$ROOT/src-tauri/tauri.conf.json"

tmp=$(mktemp)
sed "s/^version = \".*\"/version = \"$NEW\"/" "$ROOT/src-tauri/Cargo.toml" > "$tmp" && mv "$tmp" "$ROOT/src-tauri/Cargo.toml"

# ── Git commit & tag ──────────────────────────────────────────
git add "$ROOT/package.json" "$ROOT/src-tauri/tauri.conf.json" "$ROOT/src-tauri/Cargo.toml"
git commit -m "chore(release): $NEW [skip ci]"
git tag "v$NEW"

echo "✓ v$NEW"

# ── GitHub Actions outputs ────────────────────────────────────
if [ -n "${GITHUB_OUTPUT:-}" ]; then
  echo "version=$NEW" >> "$GITHUB_OUTPUT"
  echo "tag=v$NEW" >> "$GITHUB_OUTPUT"
  {
    echo "notes<<EOF"
    echo "${NOTES:-Release v$NEW}"
    echo "EOF"
  } >> "$GITHUB_OUTPUT"
fi