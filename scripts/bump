#!/bin/bash
# ────────────────────────────────────────────────────────────
# Bump version in package.json, tauri.conf.json, and Cargo.toml.
#
# CI mode  (CI=true) : always bumps patch.
# Interactive mode    : prompts for the bump type.
# Inject only         : ./scripts/bump --set-version 2.5.0
# ────────────────────────────────────────────────────────────
set -euo pipefail

ROOT="$(cd "$(dirname "$0")/.." && pwd)"
# ── Determine current version ─────────────────────────────────
if [ -n "${CI:-}" ]; then
  # In CI, derive from the latest git tag to avoid "tag already exists"
  LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
  CURRENT="${LATEST_TAG#v}"
else
  CURRENT=$(jq -r .version "$ROOT/package.json")
fi

# ── --set-version: just write a version into all files ────────
if [ "${1:-}" = "--set-version" ] && [ -n "${2:-}" ]; then
  NEW="$2"
  echo "Setting version → $NEW"
  tmp=$(mktemp)
  jq --arg v "$NEW" '.version = $v' "$ROOT/package.json" > "$tmp" && mv "$tmp" "$ROOT/package.json"
  tmp=$(mktemp)
  jq --arg v "$NEW" '.version = $v' "$ROOT/src-tauri/tauri.conf.json" > "$tmp" && mv "$tmp" "$ROOT/src-tauri/tauri.conf.json"
  sed -i.bak "s/^version = \".*\"/version = \"$NEW\"/" "$ROOT/src-tauri/Cargo.toml" && rm -f "$ROOT/src-tauri/Cargo.toml.bak"
  echo "✓ v$NEW (files only, no commit)"
  exit 0
fi

# ── Determine bump type ───────────────────────────────────────
if [ -n "${CI:-}" ]; then
  BUMP="patch"
else
  read -rp "Version bump type (major/minor/patch): " BUMP
  if [[ ! "$BUMP" =~ ^(major|minor|patch)$ ]]; then
    echo "Invalid version bump type. Exiting."
    exit 1
  fi
fi

# ── Calculate new version ─────────────────────────────────────
IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
case "$BUMP" in
  major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
  minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
  patch) PATCH=$((PATCH + 1)) ;;
esac
NEW="$MAJOR.$MINOR.$PATCH"

echo "Bumping $CURRENT → $NEW ($BUMP)"

# ── Update version in all files ───────────────────────────────
tmp=$(mktemp)
jq --arg v "$NEW" '.version = $v' "$ROOT/package.json" > "$tmp" && mv "$tmp" "$ROOT/package.json"

tmp=$(mktemp)
jq --arg v "$NEW" '.version = $v' "$ROOT/src-tauri/tauri.conf.json" > "$tmp" && mv "$tmp" "$ROOT/src-tauri/tauri.conf.json"

sed -i.bak "s/^version = \".*\"/version = \"$NEW\"/" "$ROOT/src-tauri/Cargo.toml" && rm -f "$ROOT/src-tauri/Cargo.toml.bak"

if [ -n "${CI:-}" ]; then
  echo "✓ v$NEW"
  if [ -n "${GITHUB_OUTPUT:-}" ]; then
    echo "version=$NEW" >> "$GITHUB_OUTPUT"
  fi
else
  git add "$ROOT/package.json" "$ROOT/src-tauri/tauri.conf.json" "$ROOT/src-tauri/Cargo.toml"
  git commit -m "chore(release): $NEW"
  git tag "v$NEW"
  echo "✓ v$NEW — now run: git push origin master --follow-tags"
fi